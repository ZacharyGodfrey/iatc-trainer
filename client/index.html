<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="An app for recording practice sessions for the IATC Round 1 competition format">
    <title>IATC Trainer</title>
    <link rel="shortcut icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAQAAADZc7J/AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QA/4ePzL8AAAAHdElNRQfkBwcUIzDtqVv8AAAA7klEQVRIx+2UPRKCMBCFv+gBqOAS/BTcwhk8gBVclKSAGTquYG9JZ+HEgswoEEK0oWGrRzbvZUneLhyxf5wXKxkX7jwtewNuvHi4BRMUA5U1VzGgSLboGkVqzaYmm7jp0nFG4pLYpjsl/OirEv50q8SULoiIEE48kcipJ/QrDQ0FYoFbg0cJiaYmhx5NR2yqiWjQaBpCwgluDY7MzpgOTX/y9qyefQvEuDr/heKrbDv+3EJNvrxV/0uU83dQPz2jtDlBeRtJrnlReVlZurpBbTaT3OrHtXbOfAw/DpTy34Eyjo2SwJoJqFZqO2LneAPBQX6E4ZXh/QAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAyMC0wNy0wN1QyMDozNTo0MSswMDowMAfDeWoAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjAtMDctMDdUMjA6MzU6NDErMDA6MDB2nsHWAAAAAElFTkSuQmCC">
    <script src="https://cdn.tailwindcss.com"></script>
    <style type="text/tailwindcss">
      /* CSS goes here */
    </style>
    <script src="//unpkg.com/alpinejs" defer></script>
  </head>
  <body>
    <header class=""></header>
    <main class=""></main>
    <footer class=""></footer>
    <script>
      const keyMap = (key) => {
        return key.toLowerCase().replace('[', '.').replace(/[a-z0-9\.]+/, '');
      };

      const valueMap = (value) => {
        const isNumeric = /^\d+$/.test(value);

        return isNumeric ? parseInt(value, 10) : value;
      };

      const roundToPlaces = (number, places) => {
        const factor = 10 ** places;

        return Math.round(number * factor) / factor;
      };

      const sessionMap = (session) => {
        const result = {
          timestamp: session.Timestamp,
          totalScore: 0,
          averageScore: 0,
          match1: { total: 0 },
          match2: { total: 0 },
          match3: { total: 0 },
          match4: { total: 0 },
          match5: { total: 0 },
          bigAxe: { total: 0 },
        };

        Object.entries(session).forEach(([key, value]) => {
          console.log([key, value]);
          if (key === 'Timestamp') {
            return;
          }

          const [matchLabel, throwLabel] = keyMap(key).split('.');
          const score = valueMap(value);

          result[matchLabel] = result[matchLabel] || { total: 0 };
          result[matchLabel].total += score;
          result[matchLabel][throwLabel] = score;

          if (matchLabel !== 'bigAxe') {
            result.matchTotal += score;
          }
        });

        result.averageScore = roundToPlaces(result.totalScore / 5, 3);

        return result;
      };

      const getSessions = async () => {
        const response = await fetch('/api');
        const data = await response.json();

        return data.map(sessionMap);
      };

      (async () => {
        const sessions = await getSessions();

        console.log(JSON.stringify(sessions, null, 2));
      })();
    </script>
  </body>
</html>